# Sourcecraft CI/CD –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è SlimTracker Bot
version: '1.0'

name: SlimTracker Bot CI/CD

# –¢—Ä–∏–≥–≥–µ—Ä—ã —Å–±–æ—Ä–∫–∏
triggers:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
variables:
  # Telegram Bot Token (–±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞)
  TELEGRAM_TOKEN: ${TELEGRAM_TOKEN}
  
  # Yandex Cloud YDB (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  YDB_ENDPOINT: ${YDB_ENDPOINT}
  YDB_DATABASE: ${YDB_DATABASE}
  
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  DEBUG: "False"
  LOG_LEVEL: "INFO"
  
  # Open Food Facts
  OPENFOODFACTS_REQUEST_TIMEOUT: "10"
  OPENFOODFACTS_CACHE_HOURS: "1"

# –®–∞–≥–∏ —Å–±–æ—Ä–∫–∏
stages:
  - name: test
    jobs:
      - name: Run Tests
        image: python:3.10-slim
        script:
          - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          - pip install -r requirements.txt
          - echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
          
          - echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
          - python -m pytest tests/ -v --tb=short || true
          - echo "‚úÖ –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã"
          
          - echo "üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞..."
          - python -m py_compile bot.py config.py handlers.py || true
          - echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
        
  - name: build
    jobs:
      - name: Build Docker Image
        image: docker:latest
        services:
          - docker:dind
        script:
          - echo "üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
          - docker build -t slimtracker-bot:$CI_COMMIT_SHA .
          - docker tag slimtracker-bot:$CI_COMMIT_SHA slimtracker-bot:latest
          - echo "‚úÖ Docker –æ–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω"
          
          - echo "üì¶ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—Ä–∞–∑–∞..."
          - docker save slimtracker-bot:latest -o slimtracker-bot.tar
          - echo "‚úÖ –û–±—Ä–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω"
          
        artifacts:
          paths:
            - slimtracker-bot.tar
          expire_in: 1 week
    
  - name: deploy
    jobs:
      - name: Deploy to Production
        image: alpine:latest
        needs: [build]
        script:
          - echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è..."
          
          # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞–∑
          - echo "üì• –ó–∞–≥—Ä—É–∑–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
          - docker load -i slimtracker-bot.tar
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          - echo "üîÑ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
          - docker stop slimtracker-bot || true
          - docker rm slimtracker-bot || true
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          - echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
          - >
            docker run -d \
            --name slimtracker-bot \
            --restart unless-stopped \
            --env TELEGRAM_TOKEN=${TELEGRAM_TOKEN} \
            --env YDB_ENDPOINT=${YDB_ENDPOINT} \
            --env YDB_DATABASE=${YDB_DATABASE} \
            --env YDB_JSON_PATH=/app/secrets/authorized_key.json \
            --env DEBUG=${DEBUG} \
            --env LOG_LEVEL=${LOG_LEVEL} \
            --volume /data/slimtracker:/app/data \
            --volume /secrets/authorized_key.json:/app/secrets/authorized_key.json:ro \
            slimtracker-bot:latest
          
          - echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
          - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏..."
          - sleep 10
          - docker ps | grep slimtracker-bot
          - echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –¥–µ–ø–ª–æ—è
container:
  image: slimtracker-bot:latest
  ports:
    - "8443:8443"  # –î–ª—è –≤–µ–±—Ö—É–∫–æ–≤ (–µ—Å–ª–∏ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å)
  volumes:
    - /data/slimtracker:/app/data
    - /secrets/authorized_key.json:/app/secrets/authorized_key.json:ro
  environment:
    TELEGRAM_TOKEN: ${TELEGRAM_TOKEN}
    YDB_ENDPOINT: ${YDB_ENDPOINT}
    YDB_DATABASE: ${YDB_DATABASE}
    YDB_JSON_PATH: /app/secrets/authorized_key.json
    DEBUG: ${DEBUG}
    LOG_LEVEL: ${LOG_LEVEL}
  restart: unless-stopped

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ runner
runner:
  tags:
    - docker
    - slimtracker
  executor: docker